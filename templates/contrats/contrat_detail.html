{% extends 'bases/base_users.html' %}
{% load static %}

{% block title %}Contrat #{{ contrat.id }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'contrat_list' %}">Contrats</a></li>
<li class="breadcrumb-item active">Contrat #{{ contrat.id }}</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/contrats/contrat_detail.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4 contrat-detail-container">
    <!-- En-tête amélioré -->
    <div class="contrat-header-card">
        <div class="contrat-header-content">
            <div class="contrat-title-section">
                <div class="contrat-icon">
                    <i class="fas fa-file-contract"></i>
                </div>
                <div class="contrat-text">
                    <h1>Contrat #{{ contrat.id }}</h1>
                    <p class="contrat-subtitle">Détails et suivi du contrat d'enseignement</p>
                </div>
            </div>
            <div class="contrat-status-section">
                <span class="status-badge 
                    {% if contrat.status == 'VALIDATED' %}bg-info
                    {% elif contrat.status == 'IN_PROGRESS' %}bg-primary
                    {% elif contrat.status == 'COMPLETED' %}bg-success
                    {% elif contrat.status == 'PENDING_DOCUMENTS' %}bg-warning
                    {% elif contrat.status == 'READY_FOR_PAYMENT' %}bg-success
                    {% elif contrat.status == 'PAID' %}bg-dark
                    {% endif %}">
                    {{ contrat.get_status_display }}
                </span>
            </div>
        </div>
        
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6><i class="fas fa-user-tie me-2"></i> Professeur</h6>
                    <p class="mb-0">{{ contrat.professeur.user.get_full_name }}</p>
                    <small class="text-muted">{{ contrat.professeur.user.email }}</small>
                </div>
                <div class="col-md-6 mb-3">
                    <h6><i class="fas fa-book me-2"></i> Module</h6>
                    <p class="mb-0"><strong>{{ contrat.module_propose.nom_module }}</strong></p>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6><i class="fas fa-users me-2"></i> Classe</h6>
                    <p class="mb-0">{{ contrat.classe.nom }}</p>
                    <small class="text-muted">{{ contrat.classe.departement }}</small>
                </div>
                <div class="col-md-6 mb-3">
                    <h6><i class="fas fa-chalkboard-teacher me-2"></i> Type d'Enseignement</h6>
                    <p class="mb-0">{{ contrat.get_type_enseignement_display }}</p>
                    {% if contrat.type_enseignement == 'TRONC_COMMUN' %}
                    <small class="text-muted">
                        Avec: 
                        {% for classe in contrat.classes_tronc_commun.all %}
                            {{ classe.nom }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </small>
                    {% endif %}
                </div>
            </div>
            
            <hr>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value text-primary">{{ contrat.volume_total_contractuel }}h</div>
                    <div class="stat-label">Volume Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-success">{{ contrat.volume_total_effectue }}h</div>
                    <div class="stat-label">Heures Effectuées</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value 
                        {% if contrat.taux_realisation >= 90 %}text-success
                        {% elif contrat.taux_realisation >= 50 %}text-warning
                        {% else %}text-danger{% endif %}">
                        {{ contrat.taux_realisation|floatformat:1 }}%
                    </div>
                    <div class="stat-label">Taux Réalisation</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-info">{{ contrat.montant_total_contractuel|floatformat:0 }}</div>
                    <div class="stat-label">Montant Contractuel</div>
                    <small class="text-muted">FCFA</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Colonne principale -->
        <div class="col-md-8">
            <!-- Progression détaillée -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Progression du Cours</h5>
                </div>
                <div class="card-body">
                    <div class="progress-section">
                        <!-- Cours Magistral -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span><strong>Cours Magistral (CM)</strong></span>
                                <span>{{ heures_effectuees.cours }} / {{ contrat.volume_heure_cours }}h</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: {% widthratio heures_effectuees.cours contrat.volume_heure_cours 100 %}%">
                                    {% widthratio heures_effectuees.cours contrat.volume_heure_cours 100 %}%
                                </div>
                            </div>
                        </div>
                        
                        <!-- TD -->
                        {% if contrat.volume_heure_td > 0 %}
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span><strong>Travaux Dirigés (TD)</strong></span>
                                <span>{{ heures_effectuees.td }} / {{ contrat.volume_heure_td }}h</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: {% widthratio heures_effectuees.td contrat.volume_heure_td 100 %}%">
                                    {% widthratio heures_effectuees.td contrat.volume_heure_td 100 %}%
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Progression globale -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span><strong>PROGRESSION GLOBALE</strong></span>
                                <span><strong>{{ contrat.volume_total_effectue }} / {{ contrat.volume_total_contractuel }}h</strong></span>
                            </div>
                            <div class="progress" style="height: 30px;">
                                <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: {{ contrat.taux_realisation }}%">
                                    <strong>{{ contrat.taux_realisation|floatformat:1 }}%</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Graphique -->
                    <div class="mt-4">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Pointages -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i> Pointages</h5>
                    {% if can_add_pointage %}
                    <a href="{% url 'pointage_create' contrat.id %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus-circle me-1"></i> Nouveau Pointage
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if pointages %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Heures</th>
                                    <th>Sujet</th>
                                    <th>Présence</th>
                                    <th>Enregistré par</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pointage in pointages %}
                                <tr>
                                    <td>
                                        <strong>{{ pointage.date_seance|date:"d/m/Y" }}</strong><br>
                                        {% if pointage.heure_debut %}
                                        <small class="text-muted">{{ pointage.heure_debut }} - {{ pointage.heure_fin }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if pointage.heures_cours > 0 %}
                                        <span class="badge bg-info">CM: {{ pointage.heures_cours }}h</span>
                                        {% endif %}
                                        {% if pointage.heures_td > 0 %}
                                        <span class="badge bg-primary">TD: {{ pointage.heures_td }}h</span>
                                        {% endif %}
                                        {% if pointage.heures_tp > 0 %}
                                        <span class="badge bg-warning">TP: {{ pointage.heures_tp }}h</span>
                                        {% endif %}
                                        <br>
                                        <small><strong>Total: {{ pointage.total_heures }}h</strong></small>
                                    </td>
                                    <td>
                                        {{ pointage.sujet_traite|default:"-"|truncatewords:8 }}
                                        {% if pointage.observations %}
                                        <br><small class="text-muted">{{ pointage.observations|truncatewords:10 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ pointage.enregistre_par.get_full_name }}<br>
                                        {{ pointage.date_enregistrement|date:"d/m/Y" }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> Aucun pointage enregistré pour ce contrat.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i> Actions</h5>
                </div>
                <div class="card-body">
                    {% if can_start %}
                    <a href="{% url 'contrat_start' contrat.id %}" class="btn btn-success w-100 mb-2">
                        <i class="fas fa-play-circle me-2"></i> Démarrer le Cours
                    </a>
                    {% endif %}
                    
                    {% if can_add_pointage %}
                    <a href="{% url 'pointage_create' contrat.id %}" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-plus-circle me-2"></i> Ajouter Pointage
                    </a>
                    {% endif %}
                    
                    {% if can_upload_documents %}
                    <a href="{% url 'document_upload' contrat.id %}" class="btn btn-info w-100 mb-2">
                        <i class="fas fa-cloud-upload-alt me-2"></i> Charger Documents
                    </a>
                    {% endif %}
                    
                    {% if can_complete %}
                    <a href="{% url 'contrat_complete' pk=contrat.pk %}" class="btn btn-warning w-100 mb-2">
                        <i class="fas fa-check-circle me-2"></i> Terminer le Cours
                    </a>
                    {% endif %}

                    
                    <a href="#" onclick="window.print()" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-print me-2"></i> Imprimer
                    </a>
                </div>
            </div>
            
            <!-- Documents -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-files me-2"></i> Documents</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Support de Cours
                            {% if contrat.support_cours_uploaded %}
                            <span class="badge bg-success"><i class="fas fa-check-circle"></i></span>
                            {% else %}
                            <span class="badge bg-danger"><i class="fas fa-times-circle"></i></span>
                            {% endif %}
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Syllabus
                            {% if contrat.syllabus_uploaded %}
                            <span class="badge bg-success"><i class="fas fa-check-circle"></i></span>
                            {% else %}
                            <span class="badge bg-danger"><i class="fas fa-times-circle"></i></span>
                            {% endif %}
                        </li>
                    </ul>
                    
                    {% if documents %}
                    <hr>
                    <h6 class="mt-3">Documents Chargés</h6>
                    <ul class="list-unstyled">
                        {% for doc in documents %}
                        <li class="mb-2">
                            <a href="{{ doc.fichier.url }}" target="_blank" class="text-decoration-none">
                                <i class="fas fa-file-pdf text-danger me-2"></i> {{ doc.titre }}
                            </a>
                            <br>
                            <small class="text-muted">{{ doc.type_document }} - {{ doc.date_upload|date:"d/m/Y" }}</small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
            
            <!-- Informations Financières -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i> Finance</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td>Taux Cours:</td>
                            <td class="text-end"><strong>{{ contrat.taux_horaire_cours|floatformat:0 }} FCFA</strong></td>
                        </tr>
                        {% if contrat.volume_heure_td > 0 %}
                        <tr>
                            <td>Taux TD:</td>
                            <td class="text-end"><strong>{{ contrat.taux_horaire_td|floatformat:0 }} FCFA</strong></td>
                        </tr>
                        {% endif %}
                        <tr class="table-primary">
                            <td><strong>Montant Contractuel:</strong></td>
                            <td class="text-end"><strong>{{ contrat.montant_total_contractuel|floatformat:0 }} FCFA</strong></td>
                        </tr>
                        <tr class="table-success">
                            <td><strong>Montant À Payer:</strong></td>
                            <td class="text-end"><strong>{{ contrat.calculate_montant_a_payer|floatformat:0 }} FCFA</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Dates -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> Dates</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Validation:</strong><br>
                        <small>{{ contrat.date_validation|date:"d/m/Y à H:i" }}</small>
                    </p>
                    {% if contrat.date_debut_reelle %}
                    <p class="mb-2">
                        <strong>Début:</strong><br>
                        <small>{{ contrat.date_debut_reelle|date:"d/m/Y" }}</small>
                    </p>
                    {% endif %}
                    {% if contrat.date_fin_reelle %}
                    <p class="mb-2">
                        <strong>Fin:</strong><br>
                        <small>{{ contrat.date_fin_reelle|date:"d/m/Y" }}</small>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Graphique de progression
document.addEventListener('DOMContentLoaded', function() {
    var ctx = document.getElementById('progressChart').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ progression_data.labels|safe }},
            datasets: [{
                label: 'Contractuel',
                data: {{ progression_data.contractuel|safe }},
                backgroundColor: 'rgba(74, 144, 226, 0.5)',
                borderColor: 'rgba(74, 144, 226, 1)',
                borderWidth: 2
            }, {
                label: 'Effectué',
                data: {{ progression_data.effectue|safe }},
                backgroundColor: 'rgba(92, 184, 92, 0.5)',
                borderColor: 'rgba(92, 184, 92, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Heures'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Comparaison Volumes Contractuels vs Effectués'
                }
            }
        }
    });
});
</script>
{% endblock %}