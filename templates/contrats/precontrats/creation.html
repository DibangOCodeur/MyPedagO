{% extends 'bases/base_users.html' %}
{% load static %}
{% block title %}{{ title }} - MyPedago{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/contrats/precontrats/create.css' %}">
{% endblock %}


{% block content %}
<div class="container-fluid py-4">
    
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-file-earmark-plus text-primary"></i>
                        Créer un nouveau précontrat
                    </h1>
                    <p class="text-muted mb-0">
                        Suivez les étapes pour créer un précontrat complet
                    </p>
                </div>
                <a href="#" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Retour
                </a>
            </div>
        </div>
    </div>

    <!-- Indicateur d'étapes -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="step-wizard">
                <div class="step-item active" data-step="1">
                    <div class="step-number"><span>1</span></div>
                    <div class="step-label">Professeur</div>
                </div>
                <div class="step-item" data-step="2">
                    <div class="step-number"><span>2</span></div>
                    <div class="step-label">Classe</div>
                </div>
                <div class="step-item" data-step="3">
                    <div class="step-number"><span>3</span></div>
                    <div class="step-label">Modules</div>
                </div>
                <div class="step-item" data-step="4">
                    <div class="step-number"><span>4</span></div>
                    <div class="step-label">Récapitulatif</div>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="precontrat-form">
        {% csrf_token %}
        
        <div class="row">
            <!-- Colonne principale -->
            <div class="col-lg-8">
                
                <!-- ========== ÉTAPE 1 : PROFESSEUR ========== -->
                <div class="step-content active" data-step="1">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-person-badge"></i>
                                Étape 1 : Sélectionner le professeur
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                {{ form.professeur.label_tag }}
                                {{ form.professeur }}
                                {% if form.professeur.help_text %}
                                <div class="form-text">{{ form.professeur.help_text }}</div>
                                {% endif %}
                                
                                <!-- Info professeur sélectionné -->
                                <div id="prof-info" class="alert alert-info mt-3 d-none">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                                 style="width: 50px; height: 50px; font-size: 1.2rem; font-weight: bold;">
                                                <span id="prof-initials"></span>
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-1" id="prof-nom"></h6>
                                            <small class="text-muted">
                                                <i class="bi bi-envelope"></i> <span id="prof-email"></span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-primary" id="btn-step-1-next" disabled>
                                    Suivant <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== ÉTAPE 2 : CLASSE ========== -->
                <div class="step-content" data-step="2">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-building"></i>
                                Étape 2 : Sélectionner la classe
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                {{ form.classe.label_tag }}
                                {{ form.classe }}
                                {% if form.classe.help_text %}
                                <div class="form-text">{{ form.classe.help_text }}</div>
                                {% endif %}
                                
                                <!-- Info classe sélectionnée -->
                                <div id="classe-info" class="alert alert-success mt-3 d-none">
                                    <h6 class="mb-2">
                                        <i class="bi bi-check-circle"></i> 
                                        <span id="classe-nom"></span>
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <strong>Niveau:</strong> <span id="classe-niveau" class="text-primary"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Filière:</strong> <span id="classe-filiere" class="text-primary"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" id="btn-step-2-prev">
                                    <i class="bi bi-arrow-left"></i> Précédent
                                </button>
                                <button type="button" class="btn btn-primary" id="btn-step-2-next" disabled>
                                    Suivant <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== ÉTAPE 3 : MODULES ========== -->
                <div class="step-content" data-step="3">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-book"></i>
                                Étape 3 : Sélectionner les modules
                            </h5>
                        </div>
                        <div class="card-body">                
                            <div id="modules-container" class="d-none">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    Cliquez sur les modules que vous souhaitez enseigner
                                </div>
                                <div id="modules-list"></div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" id="btn-step-3-prev">
                                    <i class="bi bi-arrow-left"></i> Précédent
                                </button>
                                <button type="button" class="btn btn-primary" id="btn-step-3-next" disabled>
                                    Suivant <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== ÉTAPE 4 : RÉCAPITULATIF ========== -->
                <div class="step-content" data-step="4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-clipboard-check"></i>
                                Récapitulatif du précontrat
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-4">
                                Vérifiez attentivement les informations avant de créer le précontrat
                            </p>

                            <!-- Informations Professeur -->
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-person-badge"></i> Professeur
                                </h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td style="width: 150px;"><strong>Nom complet:</strong></td>
                                            <td id="recap-prof-nom">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Email:</strong></td>
                                            <td id="recap-prof-email">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Informations Classe -->
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-building"></i> Classe
                                </h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td style="width: 150px;"><strong>Classe:</strong></td>
                                            <td id="recap-classe-nom">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Niveau:</strong></td>
                                            <td id="recap-classe-niveau">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Filière:</strong></td>
                                            <td id="recap-classe-filiere">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Modules sélectionnés -->
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-book"></i> 
                                    Modules sélectionnés (<span id="recap-modules-count">0</span>)
                                </h6>
                                
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 100px;">Code</th>
                                                <th>Module</th>
                                                <th style="width: 80px;">CM</th>
                                                <th style="width: 80px;">TD</th>
                                                <th style="width: 140px;">Montant (FCFA)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recap-modules-tbody">
                                            <!-- Rempli dynamiquement -->
                                        </tbody>
                                        <tfoot class="table-light">
                                            <tr>
                                                <td colspan="2" class="text-end"><strong>TOTAL:</strong></td>
                                                <td class="text-center"><strong><span id="recap-total-cm">0</span>h</strong></td>
                                                <td class="text-center"><strong><span id="recap-total-td">0</span>h</strong></td>
                                                <td class="text-end"><strong><span id="recap-total-montant">0</span> FCFA</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" id="btn-step-4-prev">
                            <i class="bi bi-arrow-left"></i> Précédent
                        </button>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Créer le précontrat
                        </button>
                    </div>
                </div>
            </div>

            <!-- Colonne résumé (sidebar) -->
            <div class="col-lg-4">
                <div class="summary-card card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-clipboard-data"></i>
                            Résumé
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2 small">Professeur</h6>
                            <p id="summary-prof" class="mb-0 text-secondary">Non sélectionné</p>
                        </div>
                        
                        <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2 small">Classe</h6>
                            <p id="summary-classe" class="mb-0 text-secondary">Non sélectionnée</p>
                            <small id="summary-classe-details" class="text-muted d-none"></small>
                        </div>
                        
                        <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2 small">Modules sélectionnés</h6>
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <span class="h4 mb-0 text-primary" id="selected-count">0</span>
                                <span class="text-muted">module(s)</span>
                            </div>
                            <div id="selected-modules-list" class="small" style="max-height: 200px; overflow-y: auto;">
                                <p class="text-muted text-center mb-0">
                                    <i class="bi bi-inbox"></i><br>
                                    Aucun module
                                </p>
                            </div>
                        </div>
                        
                        <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2 small">Volume total</h6>
                            <p class="h5 mb-0 text-info">
                                <span id="summary-total-hours">0</span>h
                            </p>
                        </div>
                        
                        <div>
                            <h6 class="text-muted mb-2 small">Montant estimé</h6>
                            <p class="h5 mb-0 text-success">
                                <span id="summary-total-amount">0</span> FCFA
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input caché pour les modules sélectionnés -->
        <input type="hidden" name="selected_modules" id="selected_modules_input">
    </form>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Création en cours...</span>
        </div>
        <p>Création du précontrat en cours...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/precontrat/wizard.js' %}"></script>
{% endblock %}