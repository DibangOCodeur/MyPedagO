{% extends 'bases/base_users.html' %}
{% load static %}

{% block title %}{{ title }} - MyPedago{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/contrats/precontrats/detail.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- En-tête -->
    <div class="main-header">
        <div class="welcome-section">
            <h1>
                <i class="fas fa-file-contract text-primary me-2"></i>
                Précontrat {{ precontrat.reference }}
            </h1>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span class="status-badge status-{{ precontrat.status|lower }}">
                {{ precontrat.get_status_display }}
            </span>
            <a href="{% url 'precontrat_list' %}" class="action-btn secondary">
                <i class="fas fa-arrow-left me-2"></i> Retour
            </a>
        </div>
    </div>

    <!-- Cartes de statistiques -->
    <div class="stats-grid mb-4">
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon users">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-menu">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <div class="stat-number">{{ precontrat.nombre_modules }}</div>
            <div class="stat-label">Module(s)</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon security">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-menu">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <div class="stat-number">{{ volumes.total }}h</div>
            <div class="stat-label">Volume Total</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon storage">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-menu">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <div class="stat-number">{{ montant_total|floatformat:0 }}</div>
            <div class="stat-label">Montant (FCFA)</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon performance">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-menu">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <div class="stat-number">{{ precontrat.annee_academique }}</div>
            <div class="stat-label">Année Académique</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <div class="content-grid">
        <!-- Colonne principale -->
        <div class="main-column">
            
            <!-- Informations générales -->
            <div class="full-width-section mb-4">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-info-circle me-2"></i>Informations générales
                    </h2>
                </div>
                <div class="info-grid">
                    
                    <!-- Professeur -->
                    <div class="info-card">
                        <div class="info-header">
                            <i class="fas fa-user-tie text-primary"></i>
                            <h3>Professeur</h3>
                        </div>
                        <div class="info-content">
                            <div class="info-row">
                                <div class="info-label">Nom complet</div>
                                <div class="info-value">{{ precontrat.professeur.get_full_name }}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Email</div>
                                <div class="info-value">
                                    <a href="mailto:{{ precontrat.professeur.email }}" class="email-link">
                                        {{ precontrat.professeur.email }}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Classe -->
                    <div class="info-card">
                        <div class="info-header">
                            <i class="fas fa-building text-primary"></i>
                            <h3>Classe</h3>
                        </div>
                        <div class="info-content">
                            <div class="info-row">
                                <div class="info-label">Classe</div>
                                <div class="info-value">{{ precontrat.classe_nom }}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Niveau</div>
                                <div class="info-value">
                                    <span class="info-badge info">{{ precontrat.classe_niveau }}</span>
                                </div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Filière</div>
                                <div class="info-value">
                                    <span class="info-badge secondary">{{ precontrat.classe_filiere }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Volumes horaires -->
                    <div class="info-card">
                        <div class="info-header">
                            <i class="fas fa-chart-bar text-primary"></i>
                            <h3>Volumes horaires</h3>
                        </div>
                        <div class="volume-grid">
                            <div class="volume-item">
                                <div class="volume-value text-primary">{{ volumes.cours }}h</div>
                                <div class="volume-label">Heures CM</div>
                            </div>
                            <div class="volume-item">
                                <div class="volume-value text-danger">{{ volumes.td }}h</div>
                                <div class="volume-label">Heures TD</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modules proposés -->
            <div class="full-width-section mb-4">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-book me-2"></i>
                        Modules proposés ({{ modules.count }})
                    </h2>
                </div>
                <div class="modules-container">
                    {% if modules %}
                        {% for module in modules %}
                        <div class="module-card">
                            <div class="module-header">
                                <div class="module-title">
                                    <h4>
                                        <strong>{{ module.code_module }}</strong> - {{ module.nom_module }}
                                    </h4>
                                    {% if module.est_valide %}
                                    <span class="status-badge status-validated">
                                        <i class="fas fa-check-circle me-1"></i>Validé
                                    </span>
                                    {% else %}
                                    <span class="status-badge status-under_review">
                                        <i class="fas fa-clock me-1"></i>En attente
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="module-amount">
                                    <div class="amount-value">{{ module.get_montant_total|floatformat:0 }} FCFA</div>
                                    <div class="amount-label">{{ module.volume_total }}h total</div>
                                </div>
                            </div>
                            
                            <div class="module-body">
                                <div class="module-meta">
                                    <i class="fas fa-folder text-muted me-1"></i>
                                    {{ module.ue_nom }}
                                </div>
                                
                                <div class="module-volumes">
                                    {% if module.volume_heure_cours > 0 %}
                                    <span class="volume-badge primary">
                                        CM: {{ module.volume_heure_cours }}h × {{ module.taux_horaire_cours|floatformat:0 }} FCFA
                                    </span>
                                    {% endif %}
                                    {% if module.volume_heure_td > 0 %}
                                    <span class="volume-badge danger">
                                        TD: {{ module.volume_heure_td }}h × {{ module.taux_horaire_td|floatformat:0 }} FCFA
                                    </span>
                                    {% endif %}
                                </div>
                                
                                {% if module.notes_validation %}
                                <div class="module-notes">
                                    <div class="notes-header">
                                        <i class="fas fa-comment-alt text-info me-1"></i>
                                        <strong>Note RH:</strong>
                                    </div>
                                    <div class="notes-content">{{ module.notes_validation }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Total -->
                        <div class="module-total">
                            <div class="total-content">
                                <h3>TOTAL GÉNÉRAL</h3>
                                <div class="total-amount">
                                    <div class="total-value">{{ montant_total|floatformat:0 }} FCFA</div>
                                    <div class="total-label">{{ volumes.total }}h au total</div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-content">
                                <i class="fas fa-inbox fa-4x"></i>
                                <h3>Aucun module proposé</h3>
                                <p>Commencez par ajouter des modules à ce précontrat.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Notes et commentaires -->
            <div class="full-width-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-comments me-2"></i>
                        Notes et commentaires
                    </h2>
                </div>
                <div class="notes-container">
                    {% if precontrat.notes_validation %}
                    <div class="note-card info">
                        <div class="note-header">
                            <i class="fas fa-check-circle text-info"></i>
                            <h4>Notes de validation</h4>
                        </div>
                        <div class="note-content">
                            {{ precontrat.notes_validation }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if precontrat.raison_rejet %}
                    <div class="note-card danger">
                        <div class="note-header">
                            <i class="fas fa-exclamation-triangle text-danger"></i>
                            <h4>Raison du rejet</h4>
                        </div>
                        <div class="note-content">
                            {{ precontrat.raison_rejet }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Colonne latérale -->
        <div class="sidebar-column">
            
            <!-- Actions -->
            <div class="quick-actions mb-4">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-bolt me-2"></i>
                        Actions
                    </h3>
                </div>
                <div class="action-buttons vertical">
                    {% if can_submit %}
                    <a href="{% url 'precontrat_recapitulatif' precontrat.pk %}" 
                       class="action-btn primary">
                        <i class="fas fa-paper-plane me-2"></i>
                        Soumettre pour validation
                    </a>
                    {% endif %}
                    
                    {% if can_edit %}
                    <a href="{% url 'precontrat_edit' precontrat.pk %}" 
                       class="action-btn secondary">
                        <i class="fas fa-edit me-2"></i>
                        Modifier
                    </a>
                    {% endif %}
                    
                    {% if can_validate %}
                    <button type="button" class="action-btn success" 
                            data-modal="validateModal">
                        <i class="fas fa-check-circle me-2"></i>
                        Valider
                    </button>
                    <button type="button" class="action-btn danger"
                            data-modal="rejectModal">
                        <i class="fas fa-times-circle me-2"></i>
                        Rejeter
                    </button>
                    {% endif %}
                    
                    <a href="{% url 'precontrat_export_pdf' precontrat.pk %}" 
                       class="action-btn secondary">
                        <i class="fas fa-file-pdf me-2"></i>
                        Exporter PDF
                    </a>
                </div>
            </div>

            <!-- Historique -->
            <div class="recent-activity">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-history me-2"></i>
                        Historique
                    </h3>
                </div>
                <div class="activity-list">
                    <div class="activity-item">
                        <div class="activity-icon update">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Création du précontrat</div>
                            <div class="activity-desc">Par {{ precontrat.cree_par.get_full_name }}</div>
                            <div class="activity-time">{{ precontrat.date_creation|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                    
                    {% if precontrat.date_soumission %}
                    <div class="activity-item">
                        <div class="activity-icon security">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Soumission pour validation</div>
                            <div class="activity-time">{{ precontrat.date_soumission|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if precontrat.date_validation %}
                    <div class="activity-item">
                        <div class="activity-icon user">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Validation du précontrat</div>
                            <div class="activity-desc">Par {{ precontrat.valide_par.get_full_name }}</div>
                            <div class="activity-time">{{ precontrat.date_validation|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Validation -->
<div class="modal-overlay" id="validateModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Valider le précontrat</h3>
            <button type="button" class="modal-close">&times;</button>
        </div>
        <form method="post" action="{% url 'precontrat_valider' precontrat.pk %}">
            {% csrf_token %}
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir valider ce précontrat ?</p>
                <div class="form-group">
                    <label for="notes_validation" class="form-label">Notes (optionnel)</label>
                    <textarea class="form-control" id="notes_validation" name="notes" rows="3" 
                              placeholder="Ajoutez des notes ou commentaires..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel" data-modal-close>Annuler</button>
                <button type="submit" class="modal-btn confirm">Valider</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Rejet -->
<div class="modal-overlay" id="rejectModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Rejeter le précontrat</h3>
            <button type="button" class="modal-close">&times;</button>
        </div>
        <form method="post" action="{% url 'precontrat_rejeter' precontrat.pk %}">
            {% csrf_token %}
            <div class="modal-body">
                <div class="alert-message warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Cette action marquera le précontrat comme rejeté.
                </div>
                <div class="form-group">
                    <label for="raison" class="form-label">Raison du rejet *</label>
                    <textarea class="form-control" id="raison" name="raison" rows="4" 
                              placeholder="Veuillez préciser la raison du rejet..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel" data-modal-close>Annuler</button>
                <button type="submit" class="modal-btn danger">Rejeter</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/precontrat/detail.js' %}"></script>
{% endblock %}