{% extends 'bases/base_users.html' %}
{% load static %}

{% block title %}{{ title }} - MyPedago{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/contrats/precontrats/detail_pre.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- En-tête -->
    <div class="main-header">
        <div class="welcome-section">
            <h1>
                <i class="fas fa-file-contract text-primary me-2"></i>
                Précontrat {{ precontrat.reference }} - {{ precontrat.classe_filiere }} {{ precontrat.classe_niveau }}
            </h1>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span class="status-badge status-{{ precontrat.status|lower }}">
                {{ precontrat.get_status_display }}
            </span>
            <a href="{% url 'precontrat_list' %}" class="action-btn secondary">
                <i class="fas fa-arrow-left me-2"></i> Retour
            </a>
        </div>
    </div>

    <!-- Cartes de statistiques -->
    <div class="stats-grid mb-4">
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon users">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-menu">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <div class="stat-number">{{ precontrat.nombre_modules }}</div>
            <div class="stat-label">Module(s)</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon security">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-menu">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <div class="stat-number">{{ volumes.total }}h</div>
            <div class="stat-label">Volume Total</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon storage">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-menu">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <div class="stat-number">{{ montant_total|floatformat:0 }}</div>
            <div class="stat-label">Montant (FCFA)</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon performance">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-menu">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <div class="stat-number">{{ precontrat.annee_academique }}</div>
            <div class="stat-label">Année Académique</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <!-- Grille principale avec Informations générales et Historique côte à côte -->
    <div class="main-content-grid mb-4">
        <!-- Informations générales -->
        <div class="info-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-info-circle me-2"></i>Informations générales
                </h2>
            </div>
            <div class="info-grid">
                
                <!-- Professeur -->
                <div class="info-card">
                    <div class="info-header">
                        <i class="fas fa-user-tie text-primary"></i>
                        <h3>Professeur</h3>
                    </div>
                    <div class="info-content">
                        <div class="info-row">
                            <div class="info-label">Nom complet</div>
                            <div class="info-value">{{ precontrat.professeur.get_full_name }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Email</div>
                            <div class="info-value">
                                <a href="mailto:{{ precontrat.professeur.email }}" class="email-link">
                                    {{ precontrat.professeur.email }}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Classe -->
                <div class="info-card">
                    <div class="info-header">
                        <i class="fas fa-building text-primary"></i>
                        <h3>Classe</h3>
                    </div>
                    <div class="info-content">
                        <div class="info-row">
                            <div class="info-label">Classe</div>
                            <div class="info-value">{{ precontrat.classe_nom }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Niveau</div>
                            <div class="info-value">
                                <span class="info-badge info">{{ precontrat.classe_niveau }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Volumes horaires -->
                <div class="info-card">
                    <div class="info-header">
                        <i class="fas fa-chart-bar text-primary"></i>
                        <h3>Volumes horaires</h3>
                    </div>
                    <div class="volume-grid">
                        <div class="volume-item">
                            <div class="volume-value text-primary">{{ volumes.cours }}h</div>
                            <div class="volume-label">Heures CM</div>
                        </div>
                        <div class="volume-item">
                            <div class="volume-value text-danger">{{ volumes.td }}h</div>
                            <div class="volume-label">Heures TD</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historique -->
        <div class="history-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-history me-2"></i>
                    Historique
                </h2>
            </div>
            <div class="activity-list">
                <div class="activity-item">
                    <div class="activity-icon update">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">Création du précontrat</div>
                        <div class="activity-desc">Par {{ precontrat.cree_par.get_full_name }}</div>
                        <div class="activity-time">{{ precontrat.date_creation|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
                
                {% if precontrat.date_soumission %}
                <div class="activity-item">
                    <div class="activity-icon security">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">Soumission pour validation</div>
                        <div class="activity-time">{{ precontrat.date_soumission|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
                {% endif %}
                
                {% if precontrat.date_validation %}
                <div class="activity-item">
                    <div class="activity-icon user">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">Validation du précontrat</div>
                        <div class="activity-desc">Par {{ precontrat.valide_par.get_full_name }}</div>
                        <div class="activity-time">{{ precontrat.date_validation|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="content-grid">
        <!-- Colonne principale -->
        <div class="main-column">
            
            <!-- Modules proposés en tableau CORRIGÉ -->
            <div class="full-width-section mb-4">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-book me-2"></i>
                        Modules proposés ({{ modules.count }})
                    </h2>
                </div>
                <div class="table-container">
                    {% if modules %}
                        <div class="modules-table-wrapper">
                            <table class="modules-table">
                                <thead>
                                    <tr>
                                        <th class="col-module">Module</th>
                                        <th class="col-ue">UE</th>
                                        <th class="col-volume">Volume CM</th>
                                        <th class="col-volume">Volume TD</th>
                                        <th class="col-taux">Taux CM</th>
                                        <th class="col-taux">Taux TD</th>
                                        <th class="col-montant">Montant</th>
                                        <th class="col-statut">Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for module in modules %}
                                    <tr class="module-row">
                                        <td class="col-module">
                                            <div class="module-info">
                                                <span class="module-name">{{ module.nom_module }}</span>
                                            </div>
                                        </td>
                                        
                                        <td class="col-ue">
                                            {% if module.ue_nom %}
                                                <span>{{ module.ue_nom }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        
                                        <td class="col-volume">
                                            <div class="volume-details">
                                                {% if module.volume_heure_cours > 0 %}
                                                <div>
                                                    <span>{{ module.volume_heure_cours }}h</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="col-volume">
                                            <div class="volume-details">
                                                {% if module.volume_heure_td > 0 %}
                                                <div>
                                                    <span>{{ module.volume_heure_td }}h</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </td>

                                        <td class="col-taux">
                                            <div class="rate-details">
                                                {% if module.volume_heure_cours > 0 %}
                                                <div class="rate-item">
                                                    <span class="rate-value">{{ module.taux_horaire_cours|floatformat:0 }} FCFA/h</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="rate-details">
                                                {% if module.volume_heure_td > 0 %}
                                                <div class="rate-item">
                                                    <span class="rate-value">{{ module.taux_horaire_td|floatformat:0 }} FCFA/h</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        
                                        <td class="col-montant">
                                            <div class="amount-cell">
                                                <strong class="amount-value">{{ module.get_montant_total|floatformat:0 }} FCFA</strong>
                                            </div>
                                        </td>
                                        
                                        <td class="col-statut">
                                            {% if module.est_valide %}
                                            <span class="status-badge status-validated">
                                                <i class="fas fa-check-circle me-1"></i>Validé
                                            </span>
                                            {% else %}
                                            <span class="status-badge status-under_review">
                                                <i class="fas fa-clock me-1"></i>En attente
                                            </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="total-label">
                                            <strong>TOTAL GÉNÉRAL</strong>
                                        </td>
                                        <td colspan="3" class="total-amount">
                                            <div class="total-summary">
                                                <strong class="total-value">{{ montant_total|floatformat:0 }} FCFA</strong>
                                                <div class="total-details">{{ volumes.total }}h au total</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-content">
                                <i class="fas fa-inbox fa-4x"></i>
                                <h3>Aucun module proposé</h3>
                                <p>Commencez par ajouter des modules à ce précontrat.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Colonne latérale pour Actions -->
        <div class="sidebar-column">
            
            <!-- Actions en bas de la sidebar -->
            <div class="quick-actions actions-bottom">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-bolt me-2"></i>
                        Actions
                    </h3>
                </div>
                <div class="action-buttons vertical">
                    <!-- BOUTON CORRIGÉ POUR LE RÉCAPITULATIF -->
                    <!-- ⭐⭐ CORRECTION : URL EXACTE -->
                    {% if can_submit or can_validate %}
                    <a href="{% url 'precontrat_recapitulatif' pk=precontrat.pk %}" 
                    class="action-btn primary">
                        <i class="fas fa-paper-plane me-2"></i>
                        {% if can_submit %}Soumettre pour validation{% endif %}
                        {% if can_validate %}Valider le précontrat{% endif %}
                    </a>
                    {% endif %}
                    
                    {% if can_edit %}
                    <a href="{% url 'precontrat_edit' precontrat.pk %}" 
                    class="action-btn secondary">
                        <i class="fas fa-edit me-2"></i>
                        Modifier
                    </a>
                    {% endif %}
                    
                    {% if can_validate %}
                    <button type="button" class="action-btn danger"
                            data-modal="rejectModal">
                        <i class="fas fa-times-circle me-2"></i>
                        Rejeter
                    </button>
                    {% endif %}
                    
                    <a href="{% url 'precontrat_export_pdf' precontrat.pk %}" 
                    class="action-btn secondary">
                        <i class="fas fa-file-pdf me-2"></i>
                        Exporter PDF
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Validation -->
<div class="modal-overlay modal-top" id="validateModal">
    <div class="modal-content modal-top-content">
        <div class="modal-header">
            <h3>Valider le précontrat</h3>
            <button type="button" class="modal-close">&times;</button>
        </div>
        <form method="post" action="{% url 'precontrat_valider' precontrat.pk %}">
            {% csrf_token %}
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir valider ce précontrat ?</p>
                <div class="form-group">
                    <label for="notes_validation" class="form-label">Notes (optionnel)</label>
                    <textarea class="form-control" id="notes_validation" name="notes" rows="3" 
                              placeholder="Ajoutez des notes ou commentaires..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel" data-modal-close>Annuler</button>
                <button type="submit" class="modal-btn confirm">Valider</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Rejet -->
<div class="modal-overlay" id="rejectModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Rejeter le précontrat</h3>
            <button type="button" class="modal-close">&times;</button>
        </div>
        <form method="post" action="{% url 'precontrat_rejeter' precontrat.pk %}">
            {% csrf_token %}
            <div class="modal-body">
                <div class="alert-message warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Cette action marquera le précontrat comme rejeté.
                </div>
                <div class="form-group">
                    <label for="raison" class="form-label">Raison du rejet *</label>
                    <textarea class="form-control" id="raison" name="raison" rows="4" 
                              placeholder="Veuillez préciser la raison du rejet..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn cancel" data-modal-close>Annuler</button>
                <button type="submit" class="modal-btn danger">Rejeter</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/precontrat/detail.js' %}"></script>
<script>
// Version simplifiée - juste pour le logging
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page détail précontrat chargée');
    console.log('Précontrat ID:', '{{ precontrat.pk }}');
    console.log('Précontrat Status:', '{{ precontrat.status }}');
    console.log('Can Submit:', '{{ can_submit }}');
    console.log('Can Validate:', '{{ can_validate }}');
});
</script>
{% endblock %}