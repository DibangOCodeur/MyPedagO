{% extends 'bases/base_users.html' %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/utilisateurs/liste.css' %}">

<!-- En-tête de page -->
<div class="users-header">
    {% comment %} <div class="page-info">
        <h2 class="page-title">Liste des Utilisateurs</h2>
        <p class="page-subtitle">Total: <strong>{{ total_users }}</strong> utilisateurs</p>
    </div> {% endcomment %}
    <div class="users-actions">
        <div class="search-box">
            <input type="text" class="search-input" placeholder="Rechercher un utilisateur...">
            <button class="search-btn">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <button class="btn-primary" id="addUserBtn">
            <i class="fas fa-user-plus"></i>
            <a href="{% url 'user_create' %}">
                Nouvel Utilisateur
            </a>
        </button>
        <button class="btn-secondary" id="filterBtn">
            <i class="fas fa-filter"></i>
            Filtres
        </button>
    </div>
</div>

<!-- Statistiques rapides -->
<div class="stats-overview">
    <div class="stat-item">
        <div class="stat-icon total">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number">{{ users|length }}</div>
            <div class="stat-label">Total Utilisateurs</div>
        </div>
    </div>
    <div class="stat-item">
        <div class="stat-icon active">
            <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number">{{ active_users }}</div>
            <div class="stat-label">Utilisateurs Actifs</div>
        </div>
    </div>
    <div class="stat-item">
        <div class="stat-icon professors">
            <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number">{{ professor_count }}</div>
            <div class="stat-label">Professeurs</div>
        </div>
    </div>
    <div class="stat-item">
        <div class="stat-icon students">
            <i class="fas fa-user-graduate"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number">{{ student_count }}</div>
            <div class="stat-label">Étudiants</div>
        </div>
    </div>
</div>

<!-- Tableau des utilisateurs -->
<div class="users-table-container">
    <div class="table-header">
        <div class="table-actions">
            <select class="action-select">
                <option value="">Actions groupées</option>
                <option value="activate">Activer</option>
                <option value="deactivate">Désactiver</option>
                <option value="delete">Supprimer</option>
            </select>
            <button class="btn-apply">Appliquer</button>
        </div>
        <div class="table-info">
            Affichage de <strong>{{ users|length }}</strong> utilisateurs
        </div>
    </div>

    <div class="table-responsive">
        <table class="users-table">
            <thead>
                <tr>
                    <th class="checkbox-cell">
                        <input type="checkbox" id="selectAll">
                    </th>
                    <th class="user-cell">Utilisateur</th>
                    <th class="role-cell">Rôle</th>
                    <th class="status-cell">Statut</th>
                    <th class="date-cell">Inscription</th>
                    <th class="last-login-cell">Dernière connexion</th>
                    <th class="actions-cell">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="user-row">
                    <td class="checkbox-cell">
                        <input type="checkbox" class="user-checkbox" value="{{ user.id }}">
                    </td>
                    <td class="user-cell">
                        <div class="user-avatar-small">
                            {% if user.profile_picture %}
                                <img src="{{ user.profile_picture.url }}" alt="{{ user.get_full_name }}">
                            {% else %}
                                <i class="fas fa-user"></i>
                            {% endif %}
                        </div>
                        <div class="user-info">
                            <div class="user-name">{{ user.get_full_name }}</div>
                            <div class="user-email">{{ user.email }}</div>
                        </div>
                    </td>
                    <td class="role-cell">
                        <span class="role-badge {{ user.role }}">{{ user.get_role_display }}</span>
                    </td>
                    <td class="status-cell">
                        <span class="status-badge {% if user.is_active %}active{% else %}inactive{% endif %}">
                            {% if user.is_active %}
                                <i class="fas fa-circle"></i> Actif
                            {% else %}
                                <i class="fas fa-circle"></i> Inactif
                            {% endif %}
                        </span>
                    </td>
                    <td class="date-cell">
                        {{ user.date_joined|date:"d/m/Y" }}
                    </td>
                    <td class="last-login-cell">
                        {% if user.last_login %}
                            {{ user.last_login|date:"d/m/Y H:i" }}
                        {% else %}
                            <span class="never">Jamais</span>
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <a href="{% url 'user_detail' user.pk %}" class="btn-action view" title="Voir le profil">
                                <i class="fas fa-eye"></i>
                            </a>                            
                            <a href="#" class="btn-action edit" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="#" class="btn-action delete" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </a>
                            <button class="btn-action more" title="Plus d'actions">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="no-data">
                        <div class="no-data-content">
                            <i class="fas fa-users"></i>
                            <h3>Aucun utilisateur trouvé</h3>
                            <p>Commencez par ajouter un nouvel utilisateur</p>
                            <button class="btn-primary" id="addUserBtnEmpty">
                                <i class="fas fa-user-plus"></i>
                                Ajouter un utilisateur
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if users %}
    <div class="pagination-container">
        <div class="pagination-info">
            Page {{ current_page }} sur {{ total_pages }}
        </div>
        <div class="pagination-controls">
            {% if has_previous %}
            <a href="?page={{ previous_page }}" class="pagination-btn prev">
                <i class="fas fa-chevron-left"></i>
                Précédent
            </a>
            {% else %}
            <span class="pagination-btn prev disabled">
                <i class="fas fa-chevron-left"></i>
                Précédent
            </span>
            {% endif %}
            
            <div class="pagination-numbers">
                {% for page in page_range %}
                    {% if page == current_page %}
                        <span class="page-number active">{{ page }}</span>
                    {% else %}
                        <a href="?page={{ page }}" class="page-number">{{ page }}</a>
                    {% endif %}
                {% endfor %}
            </div>
            
            {% if has_next %}
            <a href="?page={{ next_page }}" class="pagination-btn next">
                Suivant
                <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <span class="pagination-btn next disabled">
                Suivant
                <i class="fas fa-chevron-right"></i>
            </span>
            {% endif %}
        </div>
        <div class="pagination-size">
            <select class="page-size-select" id="pageSizeSelect">
                <option value="10" {% if page_size == 10 %}selected{% endif %}>10 par page</option>
                <option value="25" {% if page_size == 25 %}selected{% endif %}>25 par page</option>
                <option value="50" {% if page_size == 50 %}selected{% endif %}>50 par page</option>
                <option value="100" {% if page_size == 100 %}selected{% endif %}>100 par page</option>
            </select>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Mise à jour de l'heure en temps réel
    function updateCurrentTime() {
        const now = new Date();
        const dateString = now.toLocaleDateString('fr-FR', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
        const timeString = now.toLocaleTimeString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement) {
            currentTimeElement.textContent = `${dateString} à ${timeString}`;
        }
    }

    // Initialiser l'heure
    document.addEventListener('DOMContentLoaded', function() {
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);

        // Gestion de la sélection multiple
        const selectAllCheckbox = document.getElementById('selectAll');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.user-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        }

        // Ouverture du modal d'ajout
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserBtnEmpty = document.getElementById('addUserBtnEmpty');
        const addUserModal = document.getElementById('addUserModal');

        if (addUserBtn) {
            addUserBtn.addEventListener('click', function() {
                if (addUserModal) {
                    addUserModal.style.display = 'flex';
                }
            });
        }

        if (addUserBtnEmpty) {
            addUserBtnEmpty.addEventListener('click', function() {
                if (addUserModal) {
                    addUserModal.style.display = 'flex';
                }
            });
        }

        // Fermeture des modals
        document.querySelectorAll('.modal-close, .modal-btn.cancel').forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal-overlay');
                if (modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // Recherche en temps réel
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('.user-row');
                
                rows.forEach(row => {
                    const userName = row.querySelector('.user-name').textContent.toLowerCase();
                    const userEmail = row.querySelector('.user-email').textContent.toLowerCase();
                    const userRole = row.querySelector('.role-badge').textContent.toLowerCase();
                    
                    if (userName.includes(searchTerm) || userEmail.includes(searchTerm) || userRole.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        // Gestion du changement de taille de page
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                const url = new URL(window.location);
                url.searchParams.set('page_size', this.value);
                url.searchParams.set('page', '1'); // Retour à la première page
                window.location.href = url.toString();
            });
        }

        // Fermer le modal en cliquant à l'extérieur
        if (addUserModal) {
            addUserModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        }

        // Empêcher la fermeture du modal en cliquant à l'intérieur
        document.querySelectorAll('.modal-content').forEach(modalContent => {
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
    });
</script>

{% endblock %}